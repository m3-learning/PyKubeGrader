
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pykubegrader.build.build_folder &#8212; PyKubeGrader 0.0.post1.dev1+gee5eb77 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=77234041" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=b73fabb8"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pykubegrader/build/build_folder';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.0.post1.dev1+gee5eb77" />
    <meta name="docbuild:last-update" content="Mar 10, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/Drexel_blue_Logo_square_Light.png" class="logo__image only-light" alt="PyKubeGrader 0.0.post1.dev1+gee5eb77 documentation - Home"/>
    <img src="../../../_static/Drexel_blue_Logo_square_Dark.png" class="logo__image only-dark pst-js-only" alt="PyKubeGrader 0.0.post1.dev1+gee5eb77 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../readme.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing.html">
    Contributions & Help
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../license.html">
    License
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../authors.html">
    Authors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../changelog.html">
    Changelog
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../api/modules.html">
    Module Reference
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="m3-learning/PyKubeGrader" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../readme.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing.html">
    Contributions & Help
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../license.html">
    License
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../authors.html">
    Authors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../changelog.html">
    Changelog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/modules.html">
    Module Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="m3-learning/PyKubeGrader" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">pykubegrader.build.build_folder</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pykubegrader.build.build_folder</h1><div class="highlight"><pre>
<span></span><span class="c1">### Note</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">parser</span>  <span class="c1"># For robust datetime parsing</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pykubegrader.build.passwords</span><span class="w"> </span><span class="kn">import</span> <span class="n">password</span><span class="p">,</span> <span class="n">user</span>
<span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passwords not found, cannot access database&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nbformat</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.api_notebook_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPINotebookBuilder</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;JUPYTERHUB_USER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;jca92&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TOKEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;token&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DB_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://engr-131-api.eastus.cloudapp.azure.com/&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;keys_student&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;capture&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;user_name_student&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;student&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pykubegrader.tokens.tokens</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_token</span>

<span class="n">add_token</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>


<div class="viewcode-block" id="NotebookProcessor">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NotebookProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for processing Jupyter notebooks in a directory and its subdirectories.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        root_folder (str): The root directory containing notebooks to process.</span>
<span class="sd">        assignment_tag (str): Tag for the assignment being processed.</span>
<span class="sd">        solutions_folder (str): The directory where processed notebooks and solutions are stored.</span>
<span class="sd">        verbose (bool): Flag for verbose output to the console.</span>
<span class="sd">        log (bool): Flag to enable or disable logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">root_folder</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">assignment_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">solutions_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">require_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">bonus_points</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-initialization method for setting up the `NotebookProcessor` instance.</span>

<span class="sd">        This method is automatically called after the instance is created. It performs the following tasks:</span>
<span class="sd">            1. Creates a solutions folder within the root directory to store processed outputs.</span>
<span class="sd">            2. Configures logging to capture detailed information about the processing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            OSError: If the solutions folder cannot be created due to permissions or other filesystem issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_file_in_folder</span><span class="p">(</span><span class="s2">&quot;assignment_config.yaml&quot;</span><span class="p">):</span>
            <span class="c1"># Parse the YAML content</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="si">}</span><span class="s2">/assignment_config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="c1"># Extract assignment details</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">week_num</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;week&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_type&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonus_points</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bonus_points&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">require_key</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require_key&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;assignment_tag&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;week</span><span class="si">{</span><span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;week&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">week_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;week</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">week_num</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># self.week_num = week_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">week</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;week_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">week_num</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Define the folder to store solutions and ensure it exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solutions_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;_solutions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignment_total_points</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solutions_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># Create the folder if it doesn&#39;t exist</span>

        <span class="c1"># Configure logging to store log messages in the solutions folder</span>
        <span class="n">log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solutions_folder</span><span class="p">,</span> <span class="s2">&quot;notebook_processor.log&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">log_file_path</span><span class="p">,</span>  <span class="c1"># Path to the log file</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>  <span class="c1"># Log messages at INFO level and above will be recorded</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># Log message format: timestamp, level, and message</span>
        <span class="p">)</span>

        <span class="c1"># Initialize a global logger for the class</span>
        <span class="k">global</span> <span class="n">logger</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="vm">__name__</span>
        <span class="p">)</span>  <span class="c1"># Create a logger instance specific to this module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>  <span class="c1"># Assign the logger instance to the class for use in instance methods</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_point_log</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="NotebookProcessor.process_notebooks">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.process_notebooks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_notebooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively processes Jupyter notebooks in a given folder and its subfolders.</span>

<span class="sd">        The function performs the following steps:</span>
<span class="sd">        1. Iterates through all files within the root folder and subfolders.</span>
<span class="sd">        2. Identifies Jupyter notebooks by checking file extensions (.ipynb).</span>
<span class="sd">        3. Checks if each notebook contains assignment configuration metadata.</span>
<span class="sd">        4. Processes notebooks that meet the criteria using `otter assign` or other defined steps.</span>

<span class="sd">        Prerequisites:</span>
<span class="sd">            - The `has_assignment` method should be implemented to check if a notebook</span>
<span class="sd">            contains the required configuration for assignment processing.</span>
<span class="sd">            - The `_process_single_notebook` method should handle the specific processing</span>
<span class="sd">            of a single notebook, including moving it to a new folder or running</span>
<span class="sd">            additional tools like `otter assign`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            - OSError: If an issue occurs while accessing files or directories.</span>

<span class="sd">        Example:</span>
<span class="sd">            class NotebookProcessor:</span>
<span class="sd">                def __init__(self, root_folder):</span>
<span class="sd">                    self.root_folder = root_folder</span>

<span class="sd">                def has_assignment(self, notebook_path):</span>
<span class="sd">                    # Implementation to check for assignment configuration</span>
<span class="sd">                    return True  # Replace with actual check logic</span>

<span class="sd">                def _process_single_notebook(self, notebook_path):</span>
<span class="sd">                    # Implementation to process a single notebook</span>
<span class="sd">                    self._print_and_log(f&quot;Processing notebook: {notebook_path}&quot;)</span>

<span class="sd">            processor = NotebookProcessor(&quot;/path/to/root/folder&quot;)</span>
<span class="sd">            processor.process_notebooks()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ipynb_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Walk through the root folder and its subfolders</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="c1"># Check if the file is a Jupyter notebook</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ipynb&quot;</span><span class="p">):</span>
                    <span class="n">notebook_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">ipynb_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">notebook_path</span> <span class="ow">in</span> <span class="n">ipynb_files</span><span class="p">:</span>
            <span class="c1"># Check if the notebook has the required assignment configuration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_assignment</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;notebook_path = </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Process the notebook if it meets the criteria</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_notebook</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span>

        <span class="c1"># Write the dictionary to a JSON file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solutions_folder</span><span class="si">}</span><span class="s2">/total_points.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_point_log</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span>
            <span class="p">)</span>  <span class="c1"># `indent=4` for pretty formatting</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_file_in_folder</span><span class="p">(</span><span class="s2">&quot;assignment_config.yaml&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_assignment</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_initialize_function</span><span class="p">()</span></div>


<div class="viewcode-block" id="NotebookProcessor.update_initialize_function">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.update_initialize_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_initialize_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_point_log</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># assignment_tag = f&quot;week{self.week_num}-{self.assignment_type}&quot;</span>

            <span class="n">update_initialize_assignment</span><span class="p">(</span>
                <span class="n">notebook_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.ipynb&quot;</span><span class="p">),</span>
                <span class="n">assignment_points</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">assignment_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.build_payload">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.build_payload">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads YAML content for an assignment and returns Python variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            yaml_content (str): The YAML file path to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the parsed assignment data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse the YAML content</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Extract assignment details</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">week</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;week&quot;</span><span class="p">)</span>
        <span class="n">assignment_type</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_type&quot;</span><span class="p">)</span>
        <span class="n">due_date_str</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_date&quot;</span><span class="p">)</span>

        <span class="c1"># Convert due_date to a datetime object if available</span>
        <span class="n">due_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">due_date_str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">due_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">due_date_str</span><span class="p">)</span>  <span class="c1"># Automatically handles timezones</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing due_date: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Week </span><span class="si">{</span><span class="n">week</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">assignment_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Return the extracted details as a dictionary</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">week</span><span class="p">),</span>
            <span class="s2">&quot;week_number&quot;</span><span class="p">:</span> <span class="n">week</span><span class="p">,</span>
            <span class="s2">&quot;assignment_type&quot;</span><span class="p">:</span> <span class="n">assignment_type</span><span class="p">,</span>
            <span class="s2">&quot;due_date&quot;</span><span class="p">:</span> <span class="n">due_date</span><span class="p">,</span>
            <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_total_points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonus_points</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="NotebookProcessor.build_payload_notebook">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.build_payload_notebook">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_payload_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">,</span> <span class="n">notebook_title</span><span class="p">,</span> <span class="n">total_points</span><span class="p">):</span>
        <span class="c1"># Parse the YAML content</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Extract assignment details</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">week_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">week_num</span>
        <span class="n">assignment_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span>
        <span class="n">due_date_str</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_date&quot;</span><span class="p">)</span>

        <span class="c1"># Convert due_date to a datetime object if available</span>
        <span class="n">due_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">due_date_str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">due_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">due_date_str</span><span class="p">)</span>  <span class="c1"># Automatically handles timezones</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing due_date: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">notebook_title</span><span class="p">,</span>
            <span class="s2">&quot;week_number&quot;</span><span class="p">:</span> <span class="n">week_num</span><span class="p">,</span>
            <span class="s2">&quot;assignment_type&quot;</span><span class="p">:</span> <span class="n">assignment_type</span><span class="p">,</span>
            <span class="s2">&quot;due_date&quot;</span><span class="p">:</span> <span class="n">due_date</span><span class="p">,</span>
            <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="n">total_points</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_notebook">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_notebook">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notebook_title</span><span class="p">,</span> <span class="n">total_points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a POST request to add a notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define the URL</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://engr-131-api.eastus.cloudapp.azure.com/notebook&quot;</span>

        <span class="c1"># Build the payload</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_payload_notebook</span><span class="p">(</span>
            <span class="n">yaml_content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="si">}</span><span class="s2">/assignment_config.yaml&quot;</span><span class="p">,</span>
            <span class="n">notebook_title</span><span class="o">=</span><span class="n">notebook_title</span><span class="p">,</span>
            <span class="n">total_points</span><span class="o">=</span><span class="n">total_points</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Define HTTP Basic Authentication</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="p">(),</span> <span class="n">password</span><span class="p">())</span>

        <span class="c1"># Define headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>

        <span class="c1"># Serialize the payload with the custom JSON encoder</span>
        <span class="n">serialized_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_serial</span><span class="p">)</span>

        <span class="c1"># Send the POST request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">serialized_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span>
        <span class="p">)</span>

        <span class="c1"># Print the response</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_assignment">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_assignment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a POST request to add an assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define the URL</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://engr-131-api.eastus.cloudapp.azure.com/assignments&quot;</span>

        <span class="c1"># Build the payload</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_payload</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="si">}</span><span class="s2">/assignment_config.yaml&quot;</span><span class="p">)</span>

        <span class="c1"># Define HTTP Basic Authentication</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="p">(),</span> <span class="n">password</span><span class="p">())</span>

        <span class="c1"># Define headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>

        <span class="c1"># Serialize the payload with the custom JSON encoder</span>
        <span class="n">serialized_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_serial</span><span class="p">)</span>

        <span class="c1"># Send the POST request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">serialized_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span>
        <span class="p">)</span>

        <span class="c1"># Print the response</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.check_if_file_in_folder">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.check_if_file_in_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_file_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_print_and_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs a message and optionally prints it to the console.</span>

<span class="sd">        This method is used for logging important information and optionally</span>
<span class="sd">        displaying it in the console based on the `verbose` and `log` attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The message to be logged and/or printed.</span>

<span class="sd">        Behavior:</span>
<span class="sd">            - If `self.verbose` is True, the message will be printed to the console.</span>
<span class="sd">            - If `self.log` is True, the message will be logged using the class&#39;s logger.</span>

<span class="sd">        Example:</span>
<span class="sd">            self._print_and_log(&quot;Processing completed successfully.&quot;)</span>

<span class="sd">        Raises:</span>
<span class="sd">            None: This method handles exceptions internally, if any arise from logging or printing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Print the message to the console if verbosity is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Log the message if logging is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notebook_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes a single Jupyter notebook.</span>

<span class="sd">        This method handles the preparation, validation, and processing of a given notebook. It:</span>
<span class="sd">        1. Moves the notebook to a subfolder within the solutions folder.</span>
<span class="sd">        2. Creates temporary and destination folders for autograder and student files.</span>
<span class="sd">        3. Identifies and processes multiple-choice questions (MCQs).</span>
<span class="sd">        4. Runs assignment-specific tasks like executing `otter assign` and cleaning notebooks.</span>
<span class="sd">        5. Generates solution and question files and moves them to appropriate folders.</span>

<span class="sd">        Args:</span>
<span class="sd">            notebook_path (str): The file path to the Jupyter notebook to be processed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the notebook file or intermediate files are not found.</span>
<span class="sd">            OSError: If there are issues creating or moving files/directories.</span>
<span class="sd">            Exception: For unexpected errors during processing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">select_many_total_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcq_total_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_total_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">otter_total_points</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing notebook: </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing notebook: </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">notebook_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">notebook_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solutions_folder</span><span class="p">,</span> <span class="n">notebook_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">new_notebook_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># makes a temp copy of the notebook</span>
        <span class="n">temp_notebook_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notebook_name</span><span class="si">}</span><span class="s2">_temp.ipynb&quot;</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">)</span>

        <span class="c1"># Determine the path to the autograder folder</span>
        <span class="n">autograder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span> <span class="s2">&quot;dist/autograder/&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">autograder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Determine the path to the student folder</span>
        <span class="n">student_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span> <span class="s2">&quot;dist/student/&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">student_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">new_notebook_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moved: </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Notebook already in destination: </span><span class="si">{</span><span class="n">new_notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">solution_path_1</span><span class="p">,</span> <span class="n">question_path_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_choice_parser</span><span class="p">(</span>
            <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span>
        <span class="p">)</span>
        <span class="n">solution_path_2</span><span class="p">,</span> <span class="n">question_path_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_false_parser</span><span class="p">(</span>
            <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span>
        <span class="p">)</span>
        <span class="n">solution_path_3</span><span class="p">,</span> <span class="n">question_path_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_many_parser</span><span class="p">(</span>
            <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">solution_path_1</span><span class="p">,</span> <span class="n">solution_path_2</span><span class="p">,</span> <span class="n">solution_path_3</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">solution_path</span> <span class="o">=</span> <span class="n">solution_path_1</span> <span class="ow">or</span> <span class="n">solution_path_2</span> <span class="ow">or</span> <span class="n">solution_path_3</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">question_path_1</span><span class="p">,</span> <span class="n">question_path_2</span><span class="p">,</span> <span class="n">question_path_3</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">question_path</span> <span class="o">=</span> <span class="n">question_path_1</span> <span class="ow">or</span> <span class="n">question_path_2</span> <span class="ow">or</span> <span class="n">question_path_3</span>

        <span class="n">student_notebook</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">otter_total_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_response_parser</span><span class="p">(</span>
            <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="n">notebook_name</span>
        <span class="p">)</span>

        <span class="c1"># If Otter does not run, move the student file to the main directory</span>
        <span class="k">if</span> <span class="n">student_notebook</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clean_notebook</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>
            <span class="n">path_</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>
            <span class="n">path_2</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
                <span class="n">question_path</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">question_path</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Copied and cleaned student notebook: </span><span class="si">{</span><span class="n">path_</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Copied Questions to: </span><span class="si">{</span><span class="n">path_2</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">),</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">question_path</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Move the solution file to the autograder folder</span>
        <span class="k">if</span> <span class="n">solution_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># gets importable file name</span>
            <span class="n">importable_file_name</span> <span class="o">=</span> <span class="n">sanitize_string</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">solution_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Move the solution file to the autograder folder</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">solution_path</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autograder_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">importable_file_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">question_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">question_path</span><span class="p">,</span> <span class="n">student_path</span><span class="p">)</span>

        <span class="c1"># Remove the temp copy of the notebook</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

        <span class="c1"># Remove all postfix from filenames in dist</span>
        <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_postfix</span><span class="p">(</span><span class="n">autograder_path</span><span class="p">,</span> <span class="s2">&quot;_solutions&quot;</span><span class="p">)</span>
        <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_postfix</span><span class="p">(</span><span class="n">student_path</span><span class="p">,</span> <span class="s2">&quot;_questions&quot;</span><span class="p">)</span>
        <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_postfix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;_temp&quot;</span><span class="p">)</span>

        <span class="c1">### CODE TO ENSURE THAT STUDENT NOTEBOOK IS IMPORTABLE</span>
        <span class="k">if</span> <span class="n">question_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># question_root_path = os.path.dirname(question_path)</span>
            <span class="n">question_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">question_path</span><span class="p">)</span>
            <span class="n">question_file_name_sanitized</span> <span class="o">=</span> <span class="n">sanitize_string</span><span class="p">(</span>
                <span class="n">question_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">question_file_name_sanitized</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_py&quot;</span><span class="p">):</span>
                <span class="n">question_file_name_sanitized</span> <span class="o">=</span> <span class="n">question_file_name_sanitized</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span>

            <span class="c1"># Rename the file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">student_path</span><span class="p">,</span> <span class="n">question_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">student_path</span><span class="p">,</span> <span class="n">question_file_name_sanitized</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Ensure the &quot;questions&quot; folder exists</span>
            <span class="n">questions_folder_jbook</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;questions&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">questions_folder_jbook</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Copy the renamed file to the &quot;questions&quot; folder</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">student_path</span><span class="p">,</span> <span class="n">question_file_name_sanitized</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">questions_folder_jbook</span><span class="p">,</span> <span class="n">question_file_name_sanitized</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">total_points</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_many_total_points</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcq_total_points</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_total_points</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">otter_total_points</span>
        <span class="p">)</span>

        <span class="c1"># creates the assignment record in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_notebook</span><span class="p">(</span><span class="n">notebook_name</span><span class="p">,</span> <span class="n">total_points</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assignment_total_points</span> <span class="o">+=</span> <span class="n">total_points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_point_log</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">notebook_name</span><span class="p">:</span> <span class="n">total_points</span><span class="p">})</span>

        <span class="n">student_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="n">notebook_name</span> <span class="o">+</span> <span class="s2">&quot;.ipynb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_submission_cells</span><span class="p">(</span><span class="n">student_file_path</span><span class="p">,</span> <span class="n">student_file_path</span><span class="p">)</span>
        <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_empty_cells</span><span class="p">(</span><span class="n">student_file_path</span><span class="p">)</span>

<div class="viewcode-block" id="NotebookProcessor.remove_empty_cells">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.remove_empty_cells">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_empty_cells</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes empty cells from a Jupyter Notebook and saves the updated notebook.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            notebook_path (str): Path to the input Jupyter Notebook.</span>
<span class="sd">            output_path (str): Path to save the updated Jupyter Notebook. If None, it overwrites the original file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load the notebook</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nb_file</span><span class="p">:</span>
                <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nb_file</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

            <span class="c1"># Filter out empty cells</span>
            <span class="n">non_empty_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span> <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

            <span class="c1"># Update the notebook cells</span>
            <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">non_empty_cells</span>

            <span class="c1"># Save the updated notebook</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="k">if</span> <span class="n">output_path</span> <span class="k">else</span> <span class="n">notebook_path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nb_file</span><span class="p">:</span>
                <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">nb_file</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty cells removed. Updated notebook saved at: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_submission_cells">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_submission_cells">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_submission_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notebook_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds submission cells to the end of a Jupyter notebook.</span>

<span class="sd">        Args:</span>
<span class="sd">            notebook_path (str): Path to the input notebook.</span>
<span class="sd">            output_path (str): Path to save the modified notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Define the Markdown cell</span>
        <span class="n">markdown_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span>
            <span class="s2">&quot;## Submitting Assignment</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Please run the following block of code using `shift + enter` to submit your assignment, &quot;</span>
            <span class="s2">&quot;you should see your score.&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_key</span><span class="p">:</span>
            <span class="c1"># Add an additional line for validate_token()</span>
            <span class="n">validate_token_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from pykubegrader.tokens.validate_token import validate_token</span><span class="se">\n</span><span class="s2">validate_token(assignment = &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="si">}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># Define the Code cell</span>
            <span class="n">code_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">validate_token_line</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>  <span class="c1"># Add the validate_token() line</span>
                <span class="s2">&quot;from pykubegrader.submit.submit_assignment import submit_assignment</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s1">&#39;submit_assignment(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ipynb&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Define the Code cell without validate_token()</span>
            <span class="n">code_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span>
                <span class="s2">&quot;from pykubegrader.submit.submit_assignment import submit_assignment</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s1">&#39;submit_assignment(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ipynb&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Make the code cell non-editable and non-deletable</span>
        <span class="n">code_cell</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;deletable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">code_cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;skip-execution&quot;</span><span class="p">]</span>

        <span class="c1"># Add the cells to the notebook</span>
        <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">markdown_cell</span><span class="p">)</span>
        <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_cell</span><span class="p">)</span>

        <span class="c1"># Save the modified notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.free_response_parser">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.free_response_parser">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free_response_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="n">notebook_name</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_assignment</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="s2">&quot;# ASSIGNMENT CONFIG&quot;</span><span class="p">):</span>
            <span class="c1"># TODO: This is hardcoded for now, but should be in a configuration file.</span>
            <span class="n">client_private_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">),</span>
                <span class="s2">&quot;.client_private_key.bin&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">),</span>
                <span class="s2">&quot;.server_public_key.bin&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;./keys/.client_private_key.bin&quot;</span><span class="p">,</span> <span class="n">client_private_key</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;./keys/.server_public_key.bin&quot;</span><span class="p">,</span> <span class="n">server_public_key</span><span class="p">)</span>

            <span class="c1"># Extract the assignment config</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">extract_config_from_notebook</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

            <span class="n">files</span> <span class="o">=</span> <span class="n">extract_files</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># print(f&quot;Files: {files}, from {temp_notebook_path}&quot;)</span>

            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
                    <span class="p">)</span>

            <span class="n">client_private_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">notebook_subfolder</span><span class="p">,</span>
                <span class="s2">&quot;.client_private_key.bin&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">notebook_subfolder</span><span class="p">,</span>
                <span class="s2">&quot;.server_public_key.bin&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;./keys/.client_private_key.bin&quot;</span><span class="p">,</span> <span class="n">client_private_key</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;./keys/.server_public_key.bin&quot;</span><span class="p">,</span> <span class="n">server_public_key</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">FastAPINotebookBuilder</span><span class="p">(</span>
                <span class="n">notebook_path</span><span class="o">=</span><span class="n">temp_notebook_path</span><span class="p">,</span>
                <span class="n">assignment_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="p">,</span>
                <span class="n">require_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">require_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">debug_notebook</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">notebook_subfolder</span><span class="p">,</span>
                <span class="s2">&quot;dist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;autograder&quot;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_temp&quot;</span><span class="p">,</span> <span class="s2">&quot;_debugger&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_otter_assign</span><span class="p">(</span>
                <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notebook_subfolder</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying </span><span class="si">{</span><span class="n">temp_notebook_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">debug_notebook</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">debug_notebook</span><span class="p">)</span>

            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_assignment_config_cells</span><span class="p">(</span><span class="n">debug_notebook</span><span class="p">)</span>

            <span class="n">student_notebook</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;student&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notebook_name</span><span class="si">}</span><span class="s2">.ipynb&quot;</span>
            <span class="p">)</span>

            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">add_initialization_code</span><span class="p">(</span>
                <span class="n">student_notebook</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">week</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span><span class="p">,</span>
                <span class="n">require_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">require_key</span><span class="p">,</span>
                <span class="n">assignment_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">replace_temp_in_notebook</span><span class="p">(</span>
                <span class="n">student_notebook</span><span class="p">,</span> <span class="n">student_notebook</span>
            <span class="p">)</span>
            <span class="n">autograder_notebook</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">notebook_subfolder</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;autograder&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notebook_name</span><span class="si">}</span><span class="s2">.ipynb&quot;</span>
            <span class="p">)</span>
            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">replace_temp_in_notebook</span><span class="p">(</span>
                <span class="n">autograder_notebook</span><span class="p">,</span> <span class="n">autograder_notebook</span>
            <span class="p">)</span>

            <span class="n">clean_notebook</span><span class="p">(</span><span class="n">student_notebook</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">student_notebook</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Copied and cleaned student notebook: </span><span class="si">{</span><span class="n">student_notebook</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Remove the keys</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">client_private_key</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">server_public_key</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">student_notebook</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">total_points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">add_initialization_code</span><span class="p">(</span>
                <span class="n">temp_notebook_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">week</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment_type</span><span class="p">,</span>
                <span class="n">require_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">require_key</span><span class="p">,</span>
                <span class="n">assignment_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_tag</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">replace_temp_no_otter</span><span class="p">(</span>
                <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">temp_notebook_path</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="NotebookProcessor.json_serial">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.json_serial">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">json_serial</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;JSON serializer for objects not serializable by default.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> not serializable&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.remove_assignment_config_cells">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.remove_assignment_config_cells">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_assignment_config_cells</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
        <span class="c1"># Read the notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="n">nbformat</span><span class="o">.</span><span class="n">NO_CONVERT</span><span class="p">)</span>

        <span class="c1"># Filter out cells containing &quot;# ASSIGNMENT CONFIG&quot;</span>
        <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cell</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span>
            <span class="k">if</span> <span class="s2">&quot;# ASSIGNMENT CONFIG&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Save the updated notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_validate_token_cell">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_validate_token_cell">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_validate_token_cell</span><span class="p">(</span>
        <span class="n">notebook_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">require_key</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new code cell at the top of a Jupyter notebook if require_key is True.</span>

<span class="sd">        Args:</span>
<span class="sd">            notebook_path (str): The path to the notebook file to modify.</span>
<span class="sd">            require_key (bool): Whether to add the validate_token cell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">require_key</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;require_key is False. No changes made to the notebook.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">add_validate_block</span><span class="p">(</span>
            <span class="n">notebook_path</span><span class="p">,</span>
            <span class="n">require_key</span><span class="p">,</span>
            <span class="n">assignment_tag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_tag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Load the notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Create the new code cell</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_tag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span>
                <span class="s2">&quot;from pykubegrader.tokens.validate_token import validate_token</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;validate_token(&#39;type the key provided by your instructor here&#39;, assignment = &#39;</span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignment_tag&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span>
                <span class="s2">&quot;from pykubegrader.tokens.validate_token import validate_token</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;validate_token(&#39;type the key provided by your instructor here&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Add the new cell to the top of the notebook</span>
        <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_cell</span><span class="p">)</span>

        <span class="c1"># Save the modified notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_validate_block">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_validate_block">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_validate_block</span><span class="p">(</span>
        <span class="n">notebook_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">require_key</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">assignment_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the first code cell of a Jupyter notebook to add the validate_token call if require_key is True.</span>

<span class="sd">        Args:</span>
<span class="sd">            notebook_path (str): The path to the notebook file to modify.</span>
<span class="sd">            require_key (bool): Whether to add the validate_token cell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">require_key</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Load the notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Prepare the validation code</span>
        <span class="n">validation_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;validate_token(assignment = &#39;</span><span class="si">{</span><span class="n">assignment_tag</span><span class="si">}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Modify the first cell if it&#39;s a code cell, otherwise insert a new one</span>
        <span class="k">if</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span> <span class="ow">and</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
            <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">validation_code</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="n">validation_code</span><span class="p">)</span>
            <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_cell</span><span class="p">)</span>

        <span class="c1"># Save the modified notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.add_initialization_code">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.add_initialization_code">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_initialization_code</span><span class="p">(</span>
        <span class="n">notebook_path</span><span class="p">,</span>
        <span class="n">week</span><span class="p">,</span>
        <span class="n">assignment_type</span><span class="p">,</span>
        <span class="n">require_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># finds the first code cell</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">find_first_code_cell</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">import_text</span> <span class="o">=</span> <span class="s2">&quot;# You must make sure to run all cells in sequence using shift + enter or you might encounter errors</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">import_text</span> <span class="o">+=</span> <span class="s2">&quot;from pykubegrader.initialize import initialize_assignment</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">import_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">responses = initialize_assignment(&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">week</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">assignment_type</span><span class="si">}</span><span class="s1">&quot; )</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">import_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">cell</span>
        <span class="n">replace_cell_source</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_key</span><span class="p">:</span>
            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">add_validate_token_cell</span><span class="p">(</span>
                <span class="n">notebook_path</span><span class="p">,</span>
                <span class="n">require_key</span><span class="p">,</span>
                <span class="n">assignment_tag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_tag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.multiple_choice_parser">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.multiple_choice_parser">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiple_choice_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span><span class="p">):</span>
        <span class="c1">### Parse the notebook for multiple choice questions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_assignment</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Notebook </span><span class="si">{</span><span class="n">temp_notebook_path</span><span class="si">}</span><span class="s2"> has multiple choice questions&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Extract all the multiple choice questions</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">extract_MCQ</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

            <span class="c1"># determine the output file path</span>
            <span class="n">solution_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">new_notebook_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_solutions.py&quot;</span>

            <span class="c1"># Extract the first value cells</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">extract_raw_cells</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">merge_metadata</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mcq_total_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_solution_MCQ</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">solution_path</span>
            <span class="p">)</span>

            <span class="n">question_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_notebook_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ipynb&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_questions.py&quot;</span>

            <span class="n">generate_mcq_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">question_path</span><span class="p">)</span>

            <span class="n">markers</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span><span class="p">,</span> <span class="s2">&quot;# END MULTIPLE CHOICE&quot;</span><span class="p">)</span>

            <span class="n">replace_cells_between_markers</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">temp_notebook_path</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">solution_path</span><span class="p">,</span> <span class="n">question_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="NotebookProcessor.true_false_parser">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.true_false_parser">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">true_false_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span><span class="p">):</span>
        <span class="c1">### Parse the notebook for TF questions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_assignment</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="s2">&quot;# BEGIN TF&quot;</span><span class="p">):</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;# BEGIN TF&quot;</span><span class="p">,</span> <span class="s2">&quot;# END TF&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Notebook </span><span class="si">{</span><span class="n">temp_notebook_path</span><span class="si">}</span><span class="s2"> has True False questions&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Extract all the multiple choice questions</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">extract_TF</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

            <span class="c1"># determine the output file path</span>
            <span class="n">solution_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">new_notebook_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_solutions.py&quot;</span>

            <span class="c1"># Extract the first value cells</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">extract_raw_cells</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">markers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">merge_metadata</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="c1"># for data_ in data:</span>
            <span class="c1"># Generate the solution file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_total_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_solution_MCQ</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">solution_path</span>
            <span class="p">)</span>

            <span class="n">question_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_notebook_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ipynb&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_questions.py&quot;</span>

            <span class="n">generate_tf_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">question_path</span><span class="p">)</span>

            <span class="n">replace_cells_between_markers</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">temp_notebook_path</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">solution_path</span><span class="p">,</span> <span class="n">question_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="NotebookProcessor.select_many_parser">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.select_many_parser">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_many_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">new_notebook_path</span><span class="p">):</span>
        <span class="c1">### Parse the notebook for select_many questions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_assignment</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="s2">&quot;# BEGIN SELECT MANY&quot;</span><span class="p">):</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;# BEGIN SELECT MANY&quot;</span><span class="p">,</span> <span class="s2">&quot;# END SELECT MANY&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_print_and_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Notebook </span><span class="si">{</span><span class="n">temp_notebook_path</span><span class="si">}</span><span class="s2"> has True False questions&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Extract all the multiple choice questions</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">extract_SELECT_MANY</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">)</span>

            <span class="c1"># determine the output file path</span>
            <span class="n">solution_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">new_notebook_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_solutions.py&quot;</span>

            <span class="c1"># Extract the first value cells</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">extract_raw_cells</span><span class="p">(</span><span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">markers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">merge_metadata</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="c1"># for data_ in data:</span>
            <span class="c1"># Generate the solution file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_many_total_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_solution_MCQ</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">solution_path</span>
            <span class="p">)</span>

            <span class="n">question_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_notebook_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ipynb&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_questions.py&quot;</span>

            <span class="n">generate_select_many_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">question_path</span><span class="p">)</span>

            <span class="n">replace_cells_between_markers</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">temp_notebook_path</span><span class="p">,</span> <span class="n">temp_notebook_path</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">solution_path</span><span class="p">,</span> <span class="n">question_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="NotebookProcessor.replace_temp_no_otter">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.replace_temp_no_otter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_temp_no_otter</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="c1"># Load the notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Iterate through the cells and modify `cell.source`</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>  <span class="c1"># Only process code cells</span>
                <span class="k">if</span> <span class="s2">&quot;responses = initialize_assignment(&quot;</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_temp&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Save the modified notebook</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.replace_temp_in_notebook">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.replace_temp_in_notebook">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_temp_in_notebook</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces occurrences of &#39;_temp.ipynb&#39; with &#39;.ipynb&#39; in a Jupyter Notebook.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        input_file (str): Path to the input Jupyter Notebook file.</span>
<span class="sd">        output_file (str): Path to the output Jupyter Notebook file.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None: Writes the modified notebook to the output file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the notebook data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Iterate through each cell and update its content</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">cell</span><span class="p">:</span>
                <span class="c1"># Replace occurrences of &#39;_temp.ipynb&#39; in the cell source</span>
                <span class="n">cell</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_temp.ipynb&quot;</span><span class="p">,</span> <span class="s2">&quot;.ipynb&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cell</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
                <span class="p">]</span>

        <span class="c1"># Write the updated notebook to the output file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">notebook_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.merge_metadata">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.merge_metadata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_metadata</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges raw metadata with extracted question data.</span>

<span class="sd">        This method combines metadata from two sources: raw metadata and question data.</span>
<span class="sd">        It ensures that the points associated with each question are appropriately distributed</span>
<span class="sd">        and added to the final merged metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            raw (list): A list of dictionaries containing raw metadata.</span>
<span class="sd">                        Each dictionary must have a &#39;points&#39; key with a value</span>
<span class="sd">                        that can be either a list of points or a string representing a single point value.</span>
<span class="sd">            data (list): A list of dictionaries containing extracted question data.</span>
<span class="sd">                        Each dictionary represents a set of questions and their details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries where each dictionary represents a question</span>
<span class="sd">                with merged metadata and associated points.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If &#39;points&#39; is missing from any raw metadata entry.</span>
<span class="sd">            IndexError: If the number of items in `raw` and `data` do not match.</span>

<span class="sd">        Example:</span>
<span class="sd">            raw = [</span>
<span class="sd">                {&quot;points&quot;: [1.0, 2.0]},</span>
<span class="sd">                {&quot;points&quot;: &quot;3.0&quot;}</span>
<span class="sd">            ]</span>
<span class="sd">            data = [</span>
<span class="sd">                {&quot;Q1&quot;: {&quot;question_text&quot;: &quot;What is 2+2?&quot;}},</span>
<span class="sd">                {&quot;Q2&quot;: {&quot;question_text&quot;: &quot;What is 3+3?&quot;}}</span>
<span class="sd">            ]</span>
<span class="sd">            merged = merge_metadata(raw, data)</span>
<span class="sd">            print(merged)</span>
<span class="sd">            # Output:</span>
<span class="sd">            # [</span>
<span class="sd">            #     {&quot;Q1&quot;: {&quot;question_text&quot;: &quot;What is 2+2?&quot;, &quot;points&quot;: 1.0}},</span>
<span class="sd">            #     {&quot;Q2&quot;: {&quot;question_text&quot;: &quot;What is 3+3?&quot;, &quot;points&quot;: 3.0}}</span>
<span class="sd">            # ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># merged_data = []</span>

        <span class="c1"># Loop through each question set in the data</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Handle &#39;points&#39; from raw metadata: convert single string value to a list if necessary</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;points&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">points_</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;points&quot;</span><span class="p">])]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">_data</span>
                <span class="p">)</span>  <span class="c1"># Distribute the same point value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">points_</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;points&quot;</span><span class="p">]</span>  <span class="c1"># Use provided list of points</span>

            <span class="c1"># Remove &#39;points&#39; from raw metadata to avoid overwriting</span>
            <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Handle &#39;grade&#39; from raw metadata</span>
            <span class="k">if</span> <span class="s2">&quot;grade&quot;</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">grade_</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;grade&quot;</span><span class="p">]]</span>

            <span class="c1"># Merge each question&#39;s metadata with corresponding raw metadata</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Combine raw metadata with question data</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">|</span> <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># Assign the correct point value to the question</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="k">if</span> <span class="s2">&quot;grade&quot;</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grade_</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="NotebookProcessor.has_assignment">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.has_assignment">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_assignment</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="o">*</span><span class="n">tags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if a Jupyter notebook contains any of the specified configuration tags.</span>

<span class="sd">        This method checks for the presence of specific content in a Jupyter notebook</span>
<span class="sd">        to identify whether it includes any of the required headings or tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            notebook_path (str): The file path to the Jupyter notebook to be checked.</span>
<span class="sd">            *tags (str): Variable-length argument list of tags to search for.</span>
<span class="sd">                        Defaults to (&quot;# ASSIGNMENT CONFIG&quot;,).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the notebook contains any of the specified tags, False otherwise.</span>

<span class="sd">        Dependencies:</span>
<span class="sd">            - The `check_for_heading` function must be implemented. It should search</span>
<span class="sd">            for specific headings or content in a notebook file and return a boolean</span>
<span class="sd">            value indicating if any of the tags exist.</span>

<span class="sd">        Example:</span>
<span class="sd">            def check_for_heading(notebook_path, keywords):</span>
<span class="sd">                # Mock implementation of content check</span>
<span class="sd">                with open(notebook_path, &#39;r&#39;) as file:</span>
<span class="sd">                    content = file.read()</span>
<span class="sd">                return any(keyword in content for keyword in keywords)</span>

<span class="sd">            notebook_path = &quot;path/to/notebook.ipynb&quot;</span>
<span class="sd">            # Check for default tags</span>
<span class="sd">            contains_config = has_assignment(notebook_path)</span>
<span class="sd">            self._print_and_log(f&quot;Contains assignment config: {contains_config}&quot;)</span>

<span class="sd">            # Check for custom tags</span>
<span class="sd">            contains_custom = has_assignment(notebook_path, &quot;# CUSTOM CONFIG&quot;, &quot;# ANOTHER CONFIG&quot;)</span>
<span class="sd">            self._print_and_log(f&quot;Contains custom config: {contains_custom}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default tags if none are provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# ASSIGNMENT CONFIG&quot;</span><span class="p">,</span> <span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span><span class="p">]</span>

        <span class="c1"># Use the helper function to check for the presence of any specified tag</span>
        <span class="k">return</span> <span class="n">check_for_heading</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.run_otter_assign">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.run_otter_assign">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_otter_assign</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">dist_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs `otter assign` on the given notebook and outputs to the specified distribution folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dist_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;otter&quot;</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="n">notebook_path</span><span class="p">,</span> <span class="n">dist_folder</span><span class="p">]</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Otter assign completed: </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dist_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Remove all postfix _test from filenames in dist_folder</span>
            <span class="n">NotebookProcessor</span><span class="o">.</span><span class="n">remove_postfix</span><span class="p">(</span><span class="n">dist_folder</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error running `otter assign` for </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error during `otter assign` for </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="NotebookProcessor.generate_solution_MCQ">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.generate_solution_MCQ">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_solution_MCQ</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;output.py&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a Python file with solutions and total points based on the input data.</span>
<span class="sd">        If the file already exists, it appends new solutions to the existing solution dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): A list of dictionaries containing question metadata.</span>
<span class="sd">            output_file (str): Path to the output Python file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">solutions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_points</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If the output file exists, load the existing solutions and total_points</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span>
                <span class="s2">&quot;existing_module&quot;</span><span class="p">,</span> <span class="n">output_file</span>
            <span class="p">)</span>
            <span class="n">existing_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">existing_module</span><span class="p">)</span>  <span class="c1"># Load the module dynamically</span>

            <span class="c1"># Attempt to read existing solutions and total_points</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">existing_module</span><span class="p">,</span> <span class="s2">&quot;solutions&quot;</span><span class="p">):</span>
                <span class="n">solutions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">existing_module</span><span class="o">.</span><span class="n">solutions</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">existing_module</span><span class="p">,</span> <span class="s2">&quot;total_points&quot;</span><span class="p">):</span>
                <span class="n">total_points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">existing_module</span><span class="o">.</span><span class="n">total_points</span><span class="p">)</span>

        <span class="n">question_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Process new question data and update solutions and total_points</span>
        <span class="k">for</span> <span class="n">question_set</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">question_data</span> <span class="ow">in</span> <span class="n">question_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">solution_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;q</span><span class="si">{</span><span class="n">question_data</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">question_data</span><span class="p">[</span><span class="s1">&#39;subquestion_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">solutions</span><span class="p">[</span><span class="n">solution_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">question_data</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">]</span>
                <span class="n">total_points</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">question_data</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]])</span>
                <span class="n">question_points</span> <span class="o">+=</span> <span class="n">question_data</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span>

        <span class="c1"># Write updated total_points and solutions back to the file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;from typing import Any</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_points: float = </span><span class="si">{</span><span class="n">total_points</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;solutions: dict[str, Any] = {</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="n">solutions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># For safety, we assume solutions are strings, but if not, repr would be safer</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">question_points</span></div>


<div class="viewcode-block" id="NotebookProcessor.extract_MCQ">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.extract_MCQ">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_MCQ</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts questions from markdown cells and organizes them as a nested dictionary,</span>
<span class="sd">        including subquestion numbers.</span>

<span class="sd">        Args:</span>
<span class="sd">            ipynb_file (str): Path to the .ipynb file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A nested dictionary where the first-level key is the question name (text after ##),</span>
<span class="sd">                and the value is a dictionary with keys: &#39;name&#39;, &#39;subquestion_number&#39;,</span>
<span class="sd">                &#39;question_text&#39;, &#39;OPTIONS&#39;, and &#39;solution&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load the notebook file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="n">cells</span> <span class="o">=</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">subquestion_number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for subquestions</span>

            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                    <span class="c1"># Check for the start and end labels in raw cells</span>
                    <span class="n">raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                    <span class="k">if</span> <span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                        <span class="n">within_section</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">subquestion_number</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="mi">0</span>  <span class="c1"># Reset counter at the start of a new section</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="s2">&quot;# END MULTIPLE CHOICE&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                        <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">within_section</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
                    <span class="c1"># Parse markdown cell content</span>
                    <span class="n">markdown_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>

                    <span class="c1"># Extract title (## heading)</span>
                    <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;^##\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
                    <span class="p">)</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title_match</span> <span class="k">else</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                        <span class="n">subquestion_number</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="mi">1</span>  <span class="c1"># Increment the subquestion number for each question</span>
                        <span class="p">)</span>

                        <span class="c1"># Extract question text (### heading)</span>
                        <span class="n">question_text_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                            <span class="sa">r</span><span class="s2">&quot;^###\s*\*\*(.+)\*\*&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
                        <span class="p">)</span>
                        <span class="n">question_text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">question_text_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">question_text_match</span>
                            <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>

                        <span class="c1"># Extract OPTIONS (lines after #### options)</span>
                        <span class="n">options_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                            <span class="sa">r</span><span class="s2">&quot;####\s*options\s*(.+?)(?=####|$)&quot;</span><span class="p">,</span>
                            <span class="n">markdown_content</span><span class="p">,</span>
                            <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">options</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">options_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">options_match</span>
                            <span class="k">else</span> <span class="p">[]</span>
                        <span class="p">)</span>

                        <span class="c1"># Extract solution (line after #### SOLUTION)</span>
                        <span class="n">solution_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                            <span class="sa">r</span><span class="s2">&quot;####\s*SOLUTION\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                        <span class="p">)</span>
                        <span class="n">solution</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">solution_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">solution_match</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>

                        <span class="c1"># Create nested dictionary for the question</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                            <span class="s2">&quot;subquestion_number&quot;</span><span class="p">:</span> <span class="n">subquestion_number</span><span class="p">,</span>
                            <span class="s2">&quot;question_text&quot;</span><span class="p">:</span> <span class="n">question_text</span><span class="p">,</span>
                            <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
                            <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
                        <span class="p">}</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">ipynb_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid JSON in notebook file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="NotebookProcessor.remove_postfix">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.NotebookProcessor.remove_postfix">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_postfix</span><span class="p">(</span><span class="n">dist_folder</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_temp&quot;</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing postfix &#39;</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&#39; from filenames in </span><span class="si">{</span><span class="n">dist_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dist_folder</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">old_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="n">new_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">,</span> <span class="n">new_file_path</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renamed: </span><span class="si">{</span><span class="n">old_file_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="extract_raw_cells">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_raw_cells">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_raw_cells</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts all metadata from value cells in a Jupyter Notebook file for a specified heading.</span>

<span class="sd">    Args:</span>
<span class="sd">        ipynb_file (str): Path to the .ipynb file.</span>
<span class="sd">        heading (str): The heading to search for in value cells.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of dict: A list of dictionaries containing extracted metadata for each heading occurrence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Extract value cell content</span>
        <span class="n">raw_cells</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>  <span class="c1"># Join multiline sources into a single string</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Process each value cell to extract metadata</span>
        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw_cell</span> <span class="ow">in</span> <span class="n">raw_cells</span><span class="p">:</span>
            <span class="n">metadata_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_extract_metadata_from_heading</span><span class="p">(</span><span class="n">raw_cell</span><span class="p">,</span> <span class="n">heading</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">metadata_list</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">ipynb_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid JSON in notebook file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_extract_metadata_from_heading</span><span class="p">(</span><span class="n">raw_cell</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts metadata for a single value cell string each time the heading is found.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw_cell (str): String containing value cell content.</span>
<span class="sd">        heading (str): The heading to identify sections.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of dict: A list of dictionaries containing extracted key-value pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">raw_cell</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">current_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">heading</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">current_metadata</span><span class="p">:</span>
                <span class="n">metadata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_metadata</span><span class="p">)</span>  <span class="c1"># Save previous metadata</span>
            <span class="n">current_metadata</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Start new metadata block</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">current_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Extract key and value from lines</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">current_metadata</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">current_metadata</span><span class="p">:</span>  <span class="c1"># Append the last metadata block</span>
        <span class="n">metadata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_metadata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metadata_list</span>


<div class="viewcode-block" id="extract_SELECT_MANY">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_SELECT_MANY">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_SELECT_MANY</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts questions marked by `# BEGIN SELECT MANY` and `# END SELECT MANY` in markdown cells,</span>
<span class="sd">    including all lines under the SOLUTION header until the first blank line or whitespace-only line.</span>

<span class="sd">    Args:</span>
<span class="sd">        ipynb_file (str): Path to the .ipynb file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of dictionaries, where each dictionary corresponds to questions within</span>
<span class="sd">              a section. Each dictionary contains parsed questions with details like</span>
<span class="sd">              &#39;name&#39;, &#39;subquestion_number&#39;, &#39;question_text&#39;, and &#39;solution&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the notebook file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List to store results for each section</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Current section being processed</span>
        <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">subquestion_number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for subquestions</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                <span class="c1"># Check for the start and end labels in raw cells</span>
                <span class="n">raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="s2">&quot;# BEGIN SELECT MANY&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">subquestion_number</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">0</span>  <span class="c1"># Reset counter at the start of a new section</span>
                    <span class="p">)</span>
                    <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Prepare a new section dictionary</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s2">&quot;# END SELECT MANY&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>  <span class="c1"># Save the current section</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">within_section</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
                <span class="c1"># Parse markdown cell content</span>
                <span class="n">markdown_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>

                <span class="c1"># Extract title (## heading)</span>
                <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^##\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title_match</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                    <span class="n">subquestion_number</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="mi">1</span>  <span class="c1"># Increment subquestion number for each question</span>
                    <span class="p">)</span>

                    <span class="c1"># # Extract question text (### heading)</span>
                    <span class="c1"># question_text_match = re.search(</span>
                    <span class="c1">#     r&quot;^###\s*\*\*(.+)\*\*&quot;, markdown_content, re.MULTILINE</span>
                    <span class="c1"># )</span>
                    <span class="c1"># question_text = (</span>
                    <span class="c1">#     question_text_match.group(1).strip()</span>
                    <span class="c1">#     if question_text_match</span>
                    <span class="c1">#     else None</span>
                    <span class="c1"># )</span>

                    <span class="c1"># Extract question text enable multiple lines</span>
                    <span class="n">question_text</span> <span class="o">=</span> <span class="n">extract_question</span><span class="p">(</span><span class="n">markdown_content</span><span class="p">)</span>

                    <span class="c1"># Extract OPTIONS (lines after #### options)</span>
                    <span class="n">options_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;####\s*options\s*(.+?)(?=####|$)&quot;</span><span class="p">,</span>
                        <span class="n">markdown_content</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">options_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="n">options_match</span>
                        <span class="k">else</span> <span class="p">[]</span>
                    <span class="p">)</span>

                    <span class="c1"># Extract all lines under the SOLUTION header</span>
                    <span class="n">solution_start</span> <span class="o">=</span> <span class="n">markdown_content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;#### SOLUTION&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">solution_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">solution</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">markdown_content</span><span class="p">[</span><span class="n">solution_start</span><span class="p">:]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Skip the &quot;#### SOLUTION&quot; line</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>  <span class="c1"># Non-blank line after trimming spaces</span>
                                <span class="n">solution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>

                    <span class="c1"># Add question details to the current section</span>
                    <span class="n">current_section</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                        <span class="s2">&quot;subquestion_number&quot;</span><span class="p">:</span> <span class="n">subquestion_number</span><span class="p">,</span>
                        <span class="s2">&quot;question_text&quot;</span><span class="p">:</span> <span class="n">question_text</span><span class="p">,</span>
                        <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
                        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
                    <span class="p">}</span>

        <span class="k">return</span> <span class="n">sections</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">ipynb_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid JSON in notebook file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="extract_TF">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_TF">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_TF</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts True False questions from markdown cells within sections marked by</span>
<span class="sd">    `# BEGIN TF` and `# END TF`.</span>

<span class="sd">    Args:</span>
<span class="sd">        ipynb_file (str): Path to the .ipynb file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of dictionaries, where each dictionary corresponds to questions within</span>
<span class="sd">              a section. Each dictionary contains parsed questions with details like</span>
<span class="sd">              &#39;name&#39;, &#39;subquestion_number&#39;, &#39;question_text&#39;, and &#39;solution&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the notebook file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List to store results for each section</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Current section being processed</span>
        <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">subquestion_number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for subquestions</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                <span class="c1"># Check for the start and end labels in raw cells</span>
                <span class="n">raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="s2">&quot;# BEGIN TF&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">subquestion_number</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">0</span>  <span class="c1"># Reset counter at the start of a new section</span>
                    <span class="p">)</span>
                    <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Prepare a new section dictionary</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s2">&quot;# END TF&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>  <span class="c1"># Save the current section</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">within_section</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
                <span class="c1"># Parse markdown cell content</span>
                <span class="n">markdown_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>

                <span class="c1"># Extract title (## heading)</span>
                <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^##\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title_match</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                    <span class="n">subquestion_number</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="mi">1</span>  <span class="c1"># Increment subquestion number for each question</span>
                    <span class="p">)</span>

                    <span class="c1"># Extract question text (### heading)</span>
                    <span class="n">question_text_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;^###\s*\*\*(.+)\*\*&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
                    <span class="p">)</span>
                    <span class="n">question_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">question_text_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">question_text_match</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>

                    <span class="c1"># Extract solution (line after #### SOLUTION)</span>
                    <span class="n">solution_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;####\s*SOLUTION\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                    <span class="p">)</span>
                    <span class="n">solution</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">solution_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">solution_match</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>

                    <span class="c1"># Add question details to the current section</span>
                    <span class="n">current_section</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                        <span class="s2">&quot;subquestion_number&quot;</span><span class="p">:</span> <span class="n">subquestion_number</span><span class="p">,</span>
                        <span class="s2">&quot;question_text&quot;</span><span class="p">:</span> <span class="n">question_text</span><span class="p">,</span>
                        <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
                    <span class="p">}</span>

        <span class="k">return</span> <span class="n">sections</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">ipynb_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid JSON in notebook file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="extract_question">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_question">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_question</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># Regular expression to capture the multiline title</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;###\s+(.*?)\s+####&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="c1"># Stripping unnecessary whitespace and asterisks</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="extract_MCQ">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_MCQ">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_MCQ</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts multiple-choice questions from markdown cells within sections marked by</span>
<span class="sd">    `# BEGIN MULTIPLE CHOICE` and `# END MULTIPLE CHOICE`.</span>

<span class="sd">    Args:</span>
<span class="sd">        ipynb_file (str): Path to the .ipynb file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of dictionaries, where each dictionary corresponds to questions within</span>
<span class="sd">              a section. Each dictionary contains parsed questions with details like</span>
<span class="sd">              &#39;name&#39;, &#39;subquestion_number&#39;, &#39;question_text&#39;, &#39;OPTIONS&#39;, and &#39;solution&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the notebook file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List to store results for each section</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Current section being processed</span>
        <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">subquestion_number</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for subquestions</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                <span class="c1"># Check for the start and end labels in raw cells</span>
                <span class="n">raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="s2">&quot;# BEGIN MULTIPLE CHOICE&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">subquestion_number</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">0</span>  <span class="c1"># Reset counter at the start of a new section</span>
                    <span class="p">)</span>
                    <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Prepare a new section dictionary</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s2">&quot;# END MULTIPLE CHOICE&quot;</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="p">:</span>
                    <span class="n">within_section</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>  <span class="c1"># Save the current section</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">within_section</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
                <span class="c1"># Parse markdown cell content</span>
                <span class="n">markdown_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>

                <span class="c1"># Extract title (## heading)</span>
                <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^##\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title_match</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                    <span class="n">subquestion_number</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="mi">1</span>  <span class="c1"># Increment subquestion number for each question</span>
                    <span class="p">)</span>

                    <span class="c1"># # Extract question text (### heading)</span>
                    <span class="c1"># question_text_match = re.search(</span>
                    <span class="c1">#     r&quot;^###\s*\*\*(.+)\*\*&quot;, markdown_content, re.MULTILINE</span>
                    <span class="c1"># )</span>
                    <span class="c1"># question_text = (</span>
                    <span class="c1">#     question_text_match.group(1).strip()</span>
                    <span class="c1">#     if question_text_match</span>
                    <span class="c1">#     else None</span>
                    <span class="c1"># )</span>

                    <span class="c1"># Extract question text enable multiple lines</span>
                    <span class="n">question_text</span> <span class="o">=</span> <span class="n">extract_question</span><span class="p">(</span><span class="n">markdown_content</span><span class="p">)</span>

                    <span class="c1"># Extract OPTIONS (lines after #### options)</span>
                    <span class="n">options_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;####\s*options\s*(.+?)(?=####|$)&quot;</span><span class="p">,</span>
                        <span class="n">markdown_content</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">options_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="n">options_match</span>
                        <span class="k">else</span> <span class="p">[]</span>
                    <span class="p">)</span>

                    <span class="c1"># Extract solution (line after #### SOLUTION)</span>
                    <span class="n">solution_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">r</span><span class="s2">&quot;####\s*SOLUTION\s*(.+)&quot;</span><span class="p">,</span> <span class="n">markdown_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                    <span class="p">)</span>
                    <span class="n">solution</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">solution_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">solution_match</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>

                    <span class="c1"># Add question details to the current section</span>
                    <span class="n">current_section</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                        <span class="s2">&quot;subquestion_number&quot;</span><span class="p">:</span> <span class="n">subquestion_number</span><span class="p">,</span>
                        <span class="s2">&quot;question_text&quot;</span><span class="p">:</span> <span class="n">question_text</span><span class="p">,</span>
                        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
                        <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
                    <span class="p">}</span>

        <span class="k">return</span> <span class="n">sections</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">ipynb_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid JSON in notebook file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="check_for_heading">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.check_for_heading">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_for_heading</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">search_strings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a Jupyter notebook contains a heading cell whose source matches any of the given strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">search_string</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">search_string</span> <span class="ow">in</span> <span class="n">search_strings</span>
                    <span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading notebook </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="clean_notebook">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.clean_notebook">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_notebook</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes specific cells and makes Markdown cells non-editable and non-deletable by updating their metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">cleaned_cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;## Submission&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span>
                <span class="ow">and</span> <span class="s2">&quot;# Save your notebook first,&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;editable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;editable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;deletable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deletable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="s2">&quot;skip-execution&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]:</span>
                        <span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;skip-execution&quot;</span><span class="p">)</span>

                <span class="n">cleaned_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed cell: </span><span class="si">{</span><span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">cleaned_cells</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned notebook: </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning notebook </span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ensure_imports">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.ensure_imports">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_imports</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">header_lines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures specified header lines are present at the top of the file.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_file (str): The path of the file to check and modify.</span>
<span class="sd">        header_lines (list of str): Lines to ensure are present at the top.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The existing content of the file (without the header).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">existing_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">existing_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Determine missing lines</span>
    <span class="n">missing_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_lines</span> <span class="k">if</span> <span class="n">line</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_content</span><span class="p">]</span>

    <span class="c1"># Write the updated content back to the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Add missing lines at the top</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">missing_lines</span><span class="p">)</span>
        <span class="c1"># Retain the existing content</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">existing_content</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">existing_content</span></div>



<div class="viewcode-block" id="replace_cells_between_markers">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.replace_cells_between_markers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">replace_cells_between_markers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">ipynb_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces the cells between specified markers in a Jupyter Notebook (.ipynb file)</span>
<span class="sd">    with provided replacement cells and writes the result to the output file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    data (list): A list of dictionaries with data for creating replacement cells.</span>
<span class="sd">    markers (tuple): A tuple containing two strings: the BEGIN and END markers.</span>
<span class="sd">    ipynb_file (str): Path to the input Jupyter Notebook file.</span>
<span class="sd">    output_file (str): Path to the output Jupyter Notebook file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None: Writes the modified notebook to the output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">begin_marker</span><span class="p">,</span> <span class="n">end_marker</span> <span class="o">=</span> <span class="n">markers</span>
    <span class="n">file_name_ipynb</span> <span class="o">=</span> <span class="n">ipynb_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_temp.ipynb&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">file_name_ipynb</span> <span class="o">=</span> <span class="n">sanitize_string</span><span class="p">(</span><span class="n">file_name_ipynb</span><span class="p">)</span>

    <span class="c1"># Iterate over each set of replacement data</span>
    <span class="k">for</span> <span class="n">data_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>

        <span class="c1"># Create the replacement cells</span>
        <span class="n">replacement_cells</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cell_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;# Run this block of code by pressing Shift + Enter to display the question</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;from questions.</span><span class="si">{</span><span class="n">file_name_ipynb</span><span class="si">}</span><span class="s2"> import Question</span><span class="si">{</span><span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Question</span><span class="si">{</span><span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">().show()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;execution_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Process the notebook cells</span>
        <span class="n">new_cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inside_markers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Load the notebook data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ipynb_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">begin_marker</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[])):</span>
                    <span class="c1"># Enter the marked block</span>
                    <span class="n">inside_markers</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement_cells</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">inside_markers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">end_marker</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[])):</span>
                        <span class="c1"># Exit the marked block</span>
                        <span class="n">inside_markers</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">inside_markers</span><span class="p">:</span>
                <span class="c1"># Skip cells inside the marked block</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># Add cells outside the marked block</span>
                <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Update the notebook with modified cells, preserving metadata</span>
        <span class="n">notebook_data</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cells</span>

        <span class="c1"># Write the modified notebook to the output file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">notebook_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Update ipynb_file to the output file for subsequent iterations</span>
        <span class="n">ipynb_file</span> <span class="o">=</span> <span class="n">output_file</span></div>



<div class="viewcode-block" id="generate_mcq_file">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.generate_mcq_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_mcq_file</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;mc_questions.py&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a Python file defining an MCQuestion class from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): A nested dictionary containing question metadata.</span>
<span class="sd">        output_file (str): The path for the output Python file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define header lines</span>
    <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;from pykubegrader.widgets.multiple_choice import MCQuestion, MCQ</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import pykubegrader.initialize</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import panel as pn</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pn.extension()</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Ensure header lines are present</span>
    <span class="n">_existing_content</span> <span class="o">=</span> <span class="n">ensure_imports</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">header_lines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">question_dict</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Write the MCQuestion class</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;class Question</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(MCQuestion):</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    def __init__(self):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        super().__init__(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;            title=f&quot;</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;            style=MCQ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;            question_number=</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">break</span>

            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write keys</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;q</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;subquestion_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            keys=</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write options</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            options=</span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write descriptions</span>
                <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;question_text&quot;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            descriptions=</span><span class="si">{</span><span class="n">descriptions</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write points</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            points=</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_select_many_file">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.generate_select_many_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_select_many_file</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;select_many_questions.py&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a Python file defining an MCQuestion class from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): A nested dictionary containing question metadata.</span>
<span class="sd">        output_file (str): The path for the output Python file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define header lines</span>
    <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;from pykubegrader.widgets.select_many import MultiSelect, SelectMany</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import pykubegrader.initialize</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import panel as pn</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pn.extension()</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Ensure header lines are present</span>
    <span class="n">_existing_content</span> <span class="o">=</span> <span class="n">ensure_imports</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">header_lines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">question_dict</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Write the MCQuestion class</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;class Question</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(SelectMany):</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    def __init__(self):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        super().__init__(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;            title=f&quot;</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;            style=MultiSelect,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;            question_number=</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">break</span>

            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write keys</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;q</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;subquestion_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            keys=</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write descriptions</span>
                <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;question_text&quot;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            descriptions=</span><span class="si">{</span><span class="n">descriptions</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write options</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            options=</span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write points</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            points=</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">question_dict</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;grade&quot;</span> <span class="ow">in</span> <span class="n">question_dict</span><span class="p">[</span><span class="n">first_key</span><span class="p">]:</span>
                <span class="n">grade</span> <span class="o">=</span> <span class="n">question_dict</span><span class="p">[</span><span class="n">first_key</span><span class="p">][</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            grade=</span><span class="si">{</span><span class="n">grade</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_tf_file">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.generate_tf_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_tf_file</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;tf_questions.py&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a Python file defining an MCQuestion class from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): A nested dictionary containing question metadata.</span>
<span class="sd">        output_file (str): The path for the output Python file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define header lines</span>
    <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;from pykubegrader.widgets.true_false import TFQuestion, TFStyle</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import pykubegrader.initialize</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import panel as pn</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pn.extension()</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Ensure header lines are present</span>
    <span class="n">_existing_content</span> <span class="o">=</span> <span class="n">ensure_imports</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">header_lines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">question_dict</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Write the MCQuestion class</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;class Question</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(TFQuestion):</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    def __init__(self):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        super().__init__(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;            title=f&quot;</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;            style=TFStyle,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;            question_number=</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">break</span>

            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write keys</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;q</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;question number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;subquestion_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">q_value</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            keys=</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write descriptions</span>
                <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;question_text&quot;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            descriptions=</span><span class="si">{</span><span class="n">descriptions</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_key</span><span class="p">,</span> <span class="n">q_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">question_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Write points</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_value</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            points=</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="sanitize_string">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.sanitize_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sanitize_string</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a string into a valid Python variable name.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_string (str): The string to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A valid Python variable name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Replace invalid characters with underscores</span>
    <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\W|^(?=\d)&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sanitized</span></div>



<div class="viewcode-block" id="find_first_code_cell">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.find_first_code_cell">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_first_code_cell</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the first Python code cell in a Jupyter notebook and its index.</span>

<span class="sd">    Args:</span>
<span class="sd">        notebook_path (str): Path to the Jupyter notebook file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the index of the first code cell and the cell dictionary,</span>
<span class="sd">            or (None, None) if no code cell is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the notebook</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Iterate through the cells to find the first code cell</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">notebook</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[])):</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell</span>  <span class="c1"># Return the index and the first code cell</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># No code cell found</span></div>



<div class="viewcode-block" id="replace_cell_source">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.replace_cell_source">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">replace_cell_source</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">,</span> <span class="n">new_source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace the source code of a specific Jupyter notebook cell.</span>

<span class="sd">    Args:</span>
<span class="sd">        cell_index (int): Index of the cell to be modified (0-based).</span>
<span class="sd">        new_source (str): New source code to replace the cell&#39;s content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the notebook</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Check if the cell index is valid</span>
    <span class="k">if</span> <span class="n">cell_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cell_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cell index </span><span class="si">{</span><span class="n">cell_index</span><span class="si">}</span><span class="s2"> is out of range for this notebook.&quot;</span><span class="p">)</span>

    <span class="c1"># Replace the source code of the specified cell</span>
    <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">cell_index</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_source</span>

    <span class="c1"># Save the notebook</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_initialize_assignment">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.update_initialize_assignment">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_initialize_assignment</span><span class="p">(</span>
    <span class="n">notebook_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">assignment_points</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">assignment_tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for a specific line in a Jupyter Notebook and update it with additional input variables.</span>

<span class="sd">    Args:</span>
<span class="sd">        notebook_path (str): The path to the Jupyter Notebook file (.ipynb).</span>
<span class="sd">        assignment_points (Optional[float]): The assignment points variable to add (default is None).</span>
<span class="sd">        assignment_tag (Optional[str]): The assignment tag variable to add (default is None).</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the notebook content</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># Pattern to match the specific initialize_assignment line</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;responses\s*=\s*initialize_assignment\((.*?)\)&quot;</span><span class="p">)</span>

    <span class="c1"># Collect additional variables</span>
    <span class="n">additional_variables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">assignment_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assignment_points = </span><span class="si">{</span><span class="n">assignment_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">assignment_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assignment_tag = &#39;</span><span class="si">{</span><span class="n">assignment_tag</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Join additional variables into a string</span>
    <span class="n">additional_variables_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">additional_variables</span><span class="p">)</span>

    <span class="c1"># Flag to check if any replacements were made</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Iterate through notebook cells</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>  <span class="c1"># Only modify code cells</span>
            <span class="n">source_code</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source_code</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="c1"># Extract existing arguments</span>
                    <span class="n">existing_args</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c1"># Replace with the updated line</span>
                    <span class="k">if</span> <span class="n">additional_variables_str</span><span class="p">:</span>
                        <span class="n">updated_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;responses = initialize_assignment(</span><span class="si">{</span><span class="n">existing_args</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">additional_variables_str</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">updated_line</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;responses = initialize_assignment(</span><span class="si">{</span><span class="n">existing_args</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">source_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_line</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># If updated, save the notebook</span>
    <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">notebook_data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Notebook &#39;</span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&#39; has been updated.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching lines found in &#39;</span><span class="si">{</span><span class="n">notebook_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_config_from_notebook">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_config_from_notebook">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_config_from_notebook</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract configuration text from a Jupyter Notebook.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        notebook_path (str): Path to the Jupyter Notebook file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The configuration text if found, otherwise an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">notebook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Iterate through cells to find the configuration text</span>
    <span class="n">config_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>  <span class="c1"># Check for code cells</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="s2">&quot;# ASSIGNMENT CONFIG&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">config_text</span> <span class="o">=</span> <span class="n">source</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">config_text</span></div>



<div class="viewcode-block" id="extract_files">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.extract_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_files</span><span class="p">(</span><span class="n">config_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the list of files from the given configuration text, excluding .bin files.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        config_text (str): The configuration text to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of file names excluding .bin files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Regular expression to extract files list</span>
    <span class="n">file_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;files:\s*\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">config_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_pattern</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">file_pattern</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Split the list into individual file names and exclude .bin files</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">file</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.bin&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">file_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../api/pykubegrader.build.html#pykubegrader.build.build_folder.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Recursively process Jupyter notebooks with &#39;# ASSIGNMENT CONFIG&#39;, move them to a solutions folder, and run otter assign.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;root_folder&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the root folder to process&quot;</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--assignment-tag&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;assignment-tag used for calculating grades&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Reading-Week-X&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--require-key&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Require a key to be generated for the assignment&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">NotebookProcessor</span><span class="p">(</span>
        <span class="n">root_folder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span>
        <span class="n">assignment_tag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">assignment_tag</span><span class="p">,</span>
        <span class="n">require_key</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">require_key</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_notebooks</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, jagar2.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>